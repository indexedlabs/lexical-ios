# Implementation Log (Lexical iOS)

## 2025-12-27
- lexical-ios-k5i.6 (done): Added reconciler metrics recording to `RopeReconciler` (path label + planning/apply timing + dirty/range counts) so `EditorMetricsContainer` receives `.reconcilerRun` events again after the migration.
- lexical-ios-k5i.1 (done): Updated the old OptimizedReconciler fast-path tests to assert RopeReconciler behavior (metrics recorded; no full-reconcile/hydrate) instead of OptimizedReconciler path labels.
- lexical-ios-k5i.1 (done): Fixed RopeReconciler incremental range-cache maintenance for structural edits (filter subtree removes to avoid double-deletes; update element preamble/postamble lengths; propagate childrenLength deltas to ancestors; shift locations excluding ancestors; prune rangeCache on removes/inserts).
- lexical-ios-k5i.1 (done): Fixed inline image undo/redo parity by (1) building inserted node content using `appendAttributedSubtree` so decorator preambles are included, and (2) ensuring image parity tests don’t reuse a single `EditorConfig` across multiple editors (plugin instances are not reusable).
- lexical-ios-k5i.3 (done): Restored block-level paragraph spacing application in RopeReconciler (`AttributeUtils.applyBlockLevelAttributes`) so block margin/padding theme attributes are reflected in paragraph styles.
- lexical-ios-k5i.5 (done): Decorator position cache tests passing on iOS simulator (verified).
- lexical-ios-k5i.4 (done): Fixed selection mapping into newly-inserted element subtrees by recomputing range cache entries for all descendants after inserting an `ElementNode` (commit: 896c935). This fixes `SelectionTests.testInsertTextWithinBoldParagraph` and unblocks cross-node selection tests under RopeReconciler.
- lexical-ios-k5i.7 (done): Sorted RopeReconciler update operations by range-cache location to reduce order-dependent parity flakes in list/insert-block sequences (commit: 259e78a).
- lexical-ios-k5i.2 (done): Fixed large-paste regressions by skipping ancestor-only “dirty” updates, tightening block-attribute dirty inputs, and incrementally updating `TextNode` content to avoid full replacements (commit: 259e78a).
- lexical-ios-k5i.8 (done): Fixed `ModernTextKitOptimizationsTests` by shifting range-cache deltas after the old text end when a `TextNode` changes length (commit: 259e78a).
- lexical-ios-k5i (done): Full iOS simulator test suite passing (excluding benchmarks) + Playground builds after the RopeReconciler migration (commit: 259e78a).
- lexical-ios-ihl.3 (done): Speed up `pointAtStringLocation` by binary-searching child cached ranges (preserving boundary semantics) and avoiding per-call allocations in the hot path (commit: 424a49e).
- lexical-ios-ihl.5 (in progress): Added Fenwick-backed lazy location support for RopeReconciler text-only updates (no O(N) suffix shifts), with opt-in materialization before structural reconciles; plumbed Fenwick-aware location mapping through selection ↔︎ string location conversion and `pointAtStringLocation`; updated decorator layout invalidation to use `Editor.actualRange(for:)`; added `fenwickHasDeltas` tracking and hardened `actualLocation` against undersized trees; reset Fenwick state on full rebuilds/hydration.
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/MetricsTests test` (passed); `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/OptimizedReconcilerTextFastPathTests test` (passed).
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/OptimizedReconcilerHistoryParityTests -only-testing:LexicalTests/OptimizedReconcilerHistoryListQuoteParityTests/testParity_UndoRedo_QuoteSplitMerge -only-testing:LexicalTests/OptimizedReconcilerDecoratorGranularityParityTests/testParity_DeleteWordAcrossDecorator_Forward test` (passed). Playground build: `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed).
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/OptimizedReconcilerTextFastPathTests -only-testing:LexicalTests/OptimizedReconcilerHistoryParityTests -only-testing:LexicalTests/OptimizedReconcilerHistoryListQuoteParityTests -only-testing:LexicalTests/OptimizedReconcilerHistoryImageParityTests -only-testing:LexicalTests/OptimizedReconcilerDecoratorGranularityParityTests test` (passed).
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -skip-testing:LexicalTests/RopeChunkIterationTests -skip-testing:LexicalTests/RopeTextStoragePerformanceTests -skip-testing:LexicalTests/ReconcilerBenchmarkTests -skip-testing:LexicalTests/MixedDocumentLiveBenchmarkTests -skip-testing:LexicalTests/MixedDocumentBenchmarkTests -skip-testing:LexicalTests/InsertBenchmarkTests -skip-testing:LexicalTests/DFSOrderIndexingBenchmarkTests test` (passed, log: /tmp/lexical-test-results-skipbench-final.log). Playground build: `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed, log: /tmp/lexical-playground-build-final.log).
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/RopeReconcilerTests test` (passed, log: /tmp/lexical-test-ihl5-rope-reconciler.log). `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -skip-testing:LexicalTests/RopeChunkIterationTests -skip-testing:LexicalTests/RopeTextStoragePerformanceTests -skip-testing:LexicalTests/ReconcilerBenchmarkTests -skip-testing:LexicalTests/MixedDocumentLiveBenchmarkTests -skip-testing:LexicalTests/MixedDocumentBenchmarkTests -skip-testing:LexicalTests/InsertBenchmarkTests -skip-testing:LexicalTests/DFSOrderIndexingBenchmarkTests test` (passed, log: /tmp/lexical-test-results-skipbench-ihl5.log). Playground build: `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed, log: /tmp/lexical-playground-build-ihl5.log).

## 2025-12-26
- lexical-ios-qmk (done): Added regression test that pastes `sample.md` (~1200 lines) into a real window-backed editor and verifies caret moves stay fast; optimized selection-only updates by skipping the reconciler diff pipeline when there are no dirty nodes (selection-only navigation), preventing massive CPU spikes on cursor movement.
- lexical-ios-a78 (done): Added memory/timing instrumentation for large inserts + fixed native-range → Lexical selection mapping at end-of-document (range cache point mapping) to prevent flaky select+delete at the end of text after edits.
- lexical-ios-cqy (done): Reduced huge transient memory spikes when selecting very large ranges (e.g. Select All after large pastes) by clamping `TextView.selectionRects(for:)` to the visible viewport for large selections, avoiding full-document TextKit layout; added large-paste regression tests (double-paste + select-all, and multi-paste memory guard).
- lexical-ios-ihl (open): Drafted `docs/PerformanceNextSteps.md` outlining the next performance initiatives (large paste memory spikes + large-doc cursor/edit lag) and created the bd epic + subtasks for execution planning.
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' test` (passed); `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed).

## 2025-12-19
- lexical-ios-0qp (done): Added off-main text-only planning snapshot + materialization path, wired into central aggregation with state-id validation and planning timing.
- lexical-ios-8qy (done): Reverted off-main planning snapshot path (sync overhead) to keep text-only planning on main.
- lexical-ios-i8b (done): Switched decorator cache repair/sync to single-pass attachment maps; reuse lookup in decorator reconciliation.
- lexical-ios-6fw (done): Track dirty decorator positions and reposition only visible/dirty keys in LayoutManager (UIKit + AppKit).
- lexical-ios-5mc (done): Gate block-attribute pass for text-only aggregation using block-attribute diff checks.
- lexical-ios-178 (done): Added SPM resource declarations for LexicalDemoSwiftUI (assets) and excluded Info.plist/entitlements to eliminate unhandled resource warnings; remaining SwiftSoup + sysroot warnings tracked in lexical-ios-dqz + lexical-ios-kod.
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' test` (passed); `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed); `swift build --sdk "$(xcrun --sdk iphonesimulator --show-sdk-path)" -Xswiftc "-target" -Xswiftc "x86_64-apple-ios16.0-simulator"` (passed); `swift build --sdk "$(xcrun --sdk iphonesimulator --show-sdk-path)" -Xswiftc "-target" -Xswiftc "arm64-apple-ios16.0-simulator"` (passed).
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' test` (failed once with OptimizedReconcilerNoOpDeleteParityTests.testParity_BackspaceAtStartOfDocument_NoOp; rerun passed); `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/OptimizedReconcilerNoOpDeleteParityTests test` (passed); `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed); `swift build --sdk "$(xcrun --sdk iphonesimulator --show-sdk-path)" -Xswiftc "-target" -Xswiftc "x86_64-apple-ios16.0-simulator"` (passed, SwiftSoup resource warnings remain); `swift build --sdk "$(xcrun --sdk iphonesimulator --show-sdk-path)" -Xswiftc "-target" -Xswiftc "arm64-apple-ios16.0-simulator"` (passed, SwiftSoup + sysroot warnings remain).
