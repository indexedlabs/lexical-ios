# Implementation Log (Lexical iOS)

## 2025-12-27
- lexical-ios-k5i.6 (done): Added reconciler metrics recording to `RopeReconciler` (path label + planning/apply timing + dirty/range counts) so `EditorMetricsContainer` receives `.reconcilerRun` events again after the migration.
- lexical-ios-k5i.1 (in progress): Updated the old OptimizedReconciler fast-path tests to assert RopeReconciler behavior (metrics recorded; no full-reconcile/hydrate) instead of OptimizedReconciler path labels.
- lexical-ios-k5i.1 (in progress): Fixed RopeReconciler incremental range-cache maintenance for structural edits (filter subtree removes to avoid double-deletes; update element preamble/postamble lengths; propagate childrenLength deltas to ancestors; shift locations excluding ancestors; prune rangeCache on removes/inserts). This unblocked several parity tests; remaining failures are the inline image undo/redo parity tests.
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/MetricsTests test` (passed); `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/OptimizedReconcilerTextFastPathTests test` (passed).
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/OptimizedReconcilerHistoryParityTests -only-testing:LexicalTests/OptimizedReconcilerHistoryListQuoteParityTests/testParity_UndoRedo_QuoteSplitMerge -only-testing:LexicalTests/OptimizedReconcilerDecoratorGranularityParityTests/testParity_DeleteWordAcrossDecorator_Forward test` (passed). Playground build: `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed).

## 2025-12-26
- lexical-ios-qmk (done): Added regression test that pastes `sample.md` (~1200 lines) into a real window-backed editor and verifies caret moves stay fast; optimized selection-only updates by skipping the reconciler diff pipeline when there are no dirty nodes (selection-only navigation), preventing massive CPU spikes on cursor movement.
- lexical-ios-a78 (done): Added memory/timing instrumentation for large inserts + fixed native-range â†’ Lexical selection mapping at end-of-document (range cache point mapping) to prevent flaky select+delete at the end of text after edits.
- lexical-ios-cqy (done): Reduced huge transient memory spikes when selecting very large ranges (e.g. Select All after large pastes) by clamping `TextView.selectionRects(for:)` to the visible viewport for large selections, avoiding full-document TextKit layout; added large-paste regression tests (double-paste + select-all, and multi-paste memory guard).
- lexical-ios-ihl (open): Drafted `docs/PerformanceNextSteps.md` outlining the next performance initiatives (large paste memory spikes + large-doc cursor/edit lag) and created the bd epic + subtasks for execution planning.
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' test` (passed); `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed).

## 2025-12-19
- lexical-ios-0qp (done): Added off-main text-only planning snapshot + materialization path, wired into central aggregation with state-id validation and planning timing.
- lexical-ios-8qy (done): Reverted off-main planning snapshot path (sync overhead) to keep text-only planning on main.
- lexical-ios-i8b (done): Switched decorator cache repair/sync to single-pass attachment maps; reuse lookup in decorator reconciliation.
- lexical-ios-6fw (done): Track dirty decorator positions and reposition only visible/dirty keys in LayoutManager (UIKit + AppKit).
- lexical-ios-5mc (done): Gate block-attribute pass for text-only aggregation using block-attribute diff checks.
- lexical-ios-178 (done): Added SPM resource declarations for LexicalDemoSwiftUI (assets) and excluded Info.plist/entitlements to eliminate unhandled resource warnings; remaining SwiftSoup + sysroot warnings tracked in lexical-ios-dqz + lexical-ios-kod.
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' test` (passed); `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed); `swift build --sdk "$(xcrun --sdk iphonesimulator --show-sdk-path)" -Xswiftc "-target" -Xswiftc "x86_64-apple-ios16.0-simulator"` (passed); `swift build --sdk "$(xcrun --sdk iphonesimulator --show-sdk-path)" -Xswiftc "-target" -Xswiftc "arm64-apple-ios16.0-simulator"` (passed).
- Tests: `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' test` (failed once with OptimizedReconcilerNoOpDeleteParityTests.testParity_BackspaceAtStartOfDocument_NoOp; rerun passed); `xcodebuild -workspace Playground/LexicalPlayground.xcodeproj/project.xcworkspace -scheme Lexical-Package -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' -only-testing:LexicalTests/OptimizedReconcilerNoOpDeleteParityTests test` (passed); `xcodebuild -project Playground/LexicalPlayground.xcodeproj -scheme LexicalPlayground -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0' build` (passed); `swift build --sdk "$(xcrun --sdk iphonesimulator --show-sdk-path)" -Xswiftc "-target" -Xswiftc "x86_64-apple-ios16.0-simulator"` (passed, SwiftSoup resource warnings remain); `swift build --sdk "$(xcrun --sdk iphonesimulator --show-sdk-path)" -Xswiftc "-target" -Xswiftc "arm64-apple-ios16.0-simulator"` (passed, SwiftSoup + sysroot warnings remain).
